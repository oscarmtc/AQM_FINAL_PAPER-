```{r Download of packages, include=FALSE}
# Load required libraries
library(data.table)
library(margins)
```

``` {r Load of data}

data <- fread("spanish_political_attitudes_dataset_2017_to_2020.csv")

```

``` {r Code for the Preparation of the Data}

# 
data$idcode <- data$codpanelista2
data$time <- data$wave - 9
data$time <- factor(data$time, levels = 0:3, labels = c("2017", "2018", "2019", "2020"))
setorder(data, idcode, time)

data$nwaves <- data[, .N, by = idcode]$N
data$nwaves <- data$nwaves + 1

data$year <- data$wave
data$year[data$year == 8] <- 2016
data$year[data$year == 9] <- 2017
data$year[data$year == 10] <- 2018
data$year[data$year == 11] <- 2019
data$year[data$year == 12] <- 2020

data$female <- ifelse(data$sex == 2, 1, 0)

data$age4 <- cut(data$age, breaks = c(15, 25, 35, 45, 100), labels = FALSE)
data$g3cohort <- cut(data$cohort, breaks = c(14, 29, 44, 100), labels = FALSE)

data$edu3 <- cut(data$education, breaks = c(0, 4, 7, 11), labels = FALSE)
data$edu3_ <- factor(data$edu3)

data$livingpartner <- factor(data$livingpartner, labels = c("Lives with partner", "Does not live with partner"))

data$hincome_all <- replace(data$hhincome, data$hhincome == 99, NA)
data$hincome_all <- ifelse(is.na(data$hincome_all),
                           ifelse(data$year == 2017, data$hincome_all[data$year == 2018],
                                  ifelse(data$year == 2018, data$hincome_all[data$year == 2017],
                                         ifelse(data$year == 2019, data$hincome_all[data$year == 2020],
                                                ifelse(data$year == 2020, data$hincome_all[data$year == 2019], NA))))), by = idcode

data$x3hincall <- cut(data$hincome_all, breaks = c(0, 5, 8, 12), labels = FALSE)
data$dhincome_all <- cut(data$hincome_all, breaks = c(0, 5, 8, 12), labels = FALSE)

data$intpol <- (4 - data$polintr) / 3
data$dintpol <- ifelse(data$polintr %in% c(1, 2), 1, 0)

data$ideol <- data$lrself / 10
data$ideo5 <- cut(data$lrself, breaks = c(0, 2, 4, 5, 7, 10), labels = FALSE)

data$a_respect <- ifelse(data$indeprespect == 2, 1, 0)
data$a_manner <- ifelse(data$curiosmanners == 2, 1, 0)
data$a_behave <- ifelse(data$empathybehave == 2, 1, 0)
data$a_obedient <- ifelse(data$selfconfobed == 1, 1, 0)
data$authoritarian <- rowMeans(data[, c("a_respect", "a_manner", "a_behave", "a_obedient")])

data$natveco <- (10 - data$immigeco) / 10
data$natvcult <- data$immicult / 10
data$nativism <- rowMeans(data[, c("natveco", "natvcult")])

data$pop6amz <- rowMeans(data[, c("populisma", "populismd", "populismf", "populismi", "populismj", "populismn")])

data$orgterr <- (data$constpref - 1) / 4

data$imsex_cols <- data[, grep("^femindex", names(data))]
data$msexism <- rowMeans(data[, data$imsex_cols])

data$swim_msex <- rowMeans(data[, grep("^imsex_", names(data))])

data$p8m_strike <- ifelse(data$femstrike == 1, 1, 0)
data$p8m_demonst <- ifelse(data$femdemonstrate == 1, 1, 0)
data$p8m_mobiliz <- ifelse(data$feminfo == 1, 1, 0)
data$p8m_talked <- ifelse(data$femtalk == 1, 1, 0)
data$ip8m <- rowMeans(data[, c("p8m_strike", "p8m_demonst", "p8m_mobiliz", "p8m_talked")])

data$cut_violence <- (data$violence - 1) / 4

```

